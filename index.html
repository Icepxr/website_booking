<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="https://upload.wikimedia.org/wikipedia/th/thumb/5/5f/ENG_CMU_Logo.svg/1200px-ENG_CMU_Logo.svg.png">

  <style>
    :root {
      --primary: #4f46e5; --primary-hover: #4338ca; --success: #22c55e; --error: #ef4444;
      --bg-page: #f3f4f6; --bg-card: #ffffff; --bg-input: #f9fafb; --bg-popup: #1f2937;
      --bg-popup-text: #f8fafc; --bg-result: #d1fae5; --text-header: #1f2937; --text-body: #1f2937;
      --text-label: #6b7280; --text-result: #065f46; --border-color: #d1d5db;
      --shadow-color: rgba(0, 0, 0, 0.1);
    }
    body.dark-mode {
      --bg-page: #1f2937; --bg-card: #111827; --bg-input: #1e293b; --bg-popup: #f8fafc;
      --bg-popup-text: #1f2937; --bg-result: #064e3b; --text-header: #f8fafc; --text-body: #f8fafc;
      --text-label: #cbd5e1; --text-result: #dcfce7; --border-color: #374151;
      --shadow-color: rgba(0, 0, 0, 0.5);
    }
    
    body {
      margin: 0; padding: 1rem; font-family: "Prompt", sans-serif; display: flex;
      justify-content: center; align-items: center; min-height: 100vh;
      background-color: var(--bg-page); color: var(--text-body);
      transition: background-color 0.3s, color 0.3s;
    }

    .flip-card-container {
      width: 100%;
      max-width: 450px;
      height: 700px;
      perspective: 1000px;
    }

    .flip-card {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.8s;
    }

    .flip-card.is-flipped {
      transform: rotateY(180deg);
    }

    .flip-card-front, .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
      display: flex;
      flex-direction: column;
      padding: 2rem 2.5rem;
      border-radius: 20px;
      background-color: var(--bg-card);
      box-shadow: 0 15px 35px var(--shadow-color);
      transition: background-color 0.3s, box-shadow 0.3s;
    }
    
    .flip-card-back {
      transform: rotateY(180deg);
      align-items: center;
    }

    h2 { text-align: center; font-weight: 700; margin-bottom: 1.5rem; font-size: 1.5rem; color: var(--text-header); transition: color 0.3s; }
    h2 img { width: 40px; vertical-align: middle; margin-right: 10px; }
    label { display: block; margin-top: 1rem; margin-bottom: 0.3rem; font-weight: 500; font-size: 0.95rem; color: var(--text-label); transition: color 0.3s; }
    .note { font-size: 0.85rem; color: var(--text-label); margin-top: -0.2rem; margin-bottom: 0.5rem; transition: color 0.3s; }
    input, select { width: 100%; padding: 12px 15px; border-radius: 12px; border: 2px solid var(--border-color); background-color: var(--bg-input); color: var(--text-body); font-size: 1rem; font-family: "Prompt", sans-serif; transition: all 0.3s; }
    input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2); }
    body.dark-mode input[type="datetime-local"]::-webkit-calendar-picker-indicator { filter: invert(1); }

    button, .action-button { width: 100%; padding: 14px; margin-top: 25px; border-radius: 12px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; background-color: var(--primary); color: #ffffff; transition: all 0.3s ease; text-align: center; }
    button:hover:not(:disabled), .action-button:hover { background-color: var(--primary-hover); transform: translateY(-2px); box-shadow: 0 6px 18px rgba(79, 70, 229, 0.3); }
    button:disabled { cursor: not-allowed; opacity: 0.7; }

    .result { margin-top: 20px; padding: 1rem; border-left: 5px solid var(--success); border-radius: 12px; display: none; animation: fadeIn 0.5s ease forwards; background-color: var(--bg-result); color: var(--text-result); transition: background-color 0.3s, color 0.3s, border-color 0.3s; }

    .popup { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); padding: 8px 16px; border-radius: 10px; font-size: 0.9rem; display: none; animation: fadeInDown 0.3s ease; background-color: var(--bg-popup); color: var(--bg-popup-text); }

    .alert-box { position: fixed; top: 20px; right: 10px; padding: 1rem 1.5rem; border-radius: 12px; z-index: 1000; transform: translateX(120%); background-color: var(--bg-card); color: var(--text-body); border-left: 5px solid var(--error); box-shadow: 0 5px 18px var(--shadow-color); transition: transform 0.5s; }
    .alert-box.show { transform: translateX(0); } .alert-box.success { border-left-color: var(--success); }

    #bookingList { width: 100%; height: 100%; overflow-y: auto; padding-right: 10px; }
    .booking-item { background-color: var(--bg-input); border-radius: 10px; padding: 12px; margin-bottom: 10px; border-left: 4px solid var(--primary); font-size: 0.9rem; }
    .booking-item b { color: var(--text-header); }

    .theme-toggle { position: fixed; top: 20px; left: 20px; z-index: 999; }
    .theme-toggle input { display: none; }
    .toggle-label { display: flex; align-items: center; width: 60px; height: 30px; background-color: var(--border-color); border-radius: 50px; position: relative; cursor: pointer; transition: background-color 0.4s; }
    .toggle-ball { width: 26px; height: 26px; background-color: #fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: transform 0.4s; box-shadow: 0 3px 8px rgba(0,0,0,0.2); }
    input:checked + .toggle-label { background-color: var(--primary); }
    input:checked + .toggle-label .toggle-ball { transform: translateX(30px); }

    .flip-button {
      position: absolute; top: 16px; right: 16px;
      width: 60px; height: 60px; background: transparent;
      border: none; border-radius: 50%; display: flex;
      align-items: center; justify-content: center;
      cursor: pointer; z-index: 10; transition: background-color 0.3s, transform 0.2s;
    }
    .flip-button:hover { background-color: rgba(79,70,229,0.1); transform: scale(1.1); }
    .flip-button svg { width: 22px; height: 22px; stroke: var(--text-label); transition: stroke 0.3s; }
    .flip-button:hover svg { stroke: var(--primary); }

  </style>
</head>
<body>
  
  <div class="theme-toggle">
    <input type="checkbox" id="toggleTheme">
    <label for="toggleTheme" class="toggle-label"><span class="toggle-ball"></span></label>
  </div>

  <div id="alertBox" class="alert-box"></div>

  <div class="flip-card-container">
    <div class="flip-card" id="flipCard">
      
      <div class="flip-card-front">
        <button class="flip-button" id="viewAvailableBtn" title="‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á ">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" /></svg>
        </button>

        <div class="popup" id="popup">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</div>
        <h2><img src="https://upload.wikimedia.org/wikipedia/th/thumb/5/5f/ENG_CMU_Logo.svg/1200px-ENG_CMU_Logo.svg.png" alt="CMU Logo">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</h2>
        
        <form id="bookingForm">
          <label for="room">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</label>
          <select id="room" required>
            <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>
            <option value="Room 1">Room 1</option>
            <option value="Room 2">Room 2</option>
            <option value="Room 3">Room 3</option>
          </select>

          <label for="name">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
          <input type="text" id="name" required>

          <label for="studentId">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
          <input type="text" id="studentId" required>

          <label for="date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
          <input type="date" id="date" required>

          <label for="time">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
          <p class="note">* ‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡∏•‡∏∞‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)</p>
          <input type="time" id="time" step="3600" required>

          <button type="submit" id="submitBtn">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
        </form>

        <div class="result" id="resultBox"></div>
      </div>

      <div class="flip-card-back">
        <button class="flip-button" id="backToFormBtn" title="‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏á">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" /></svg>
        </button>
        <h2>üìã ‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á</h2>
        <div id="bookingList"><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div>
      </div>
      

    </div>
  </div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbwbZlZG-yX3Amfr5bIOqZFCGyt2QnVCQWvHEd9lQZDb5VwvcM0Sa16Q1AMRyZ4w6Kjn/exec";

const toggle = document.getElementById("toggleTheme");
const body = document.body;
function setTheme(isDark) {
  body.classList.toggle("dark-mode", isDark);
  localStorage.setItem("theme", isDark ? "dark" : "light");
  toggle.checked = isDark;
}
toggle.addEventListener("change", (e) => setTheme(e.target.checked));
(function initTheme() {
  const savedTheme = localStorage.getItem("theme");
  setTheme(savedTheme ? savedTheme === "dark" : window.matchMedia("(prefers-color-scheme: dark)").matches);
})();

const flipCard = document.getElementById("flipCard");
const viewBookingsBtn = document.getElementById("viewBookingsBtn");
const backToFormBtn = document.getElementById("backToFormBtn");
const bookingListDiv = document.getElementById("bookingList");

/*async function fetchAndDisplayBookings() {
  bookingListDiv.innerHTML = "<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á...</p>";
  try {
    const response = await fetch(scriptURL);
    const result_Get = await response.json();
    if (result_Get.status === "success" && Array.isArray(result_Get.data) && result_Get.data.length > 0) {
      const html = result_Get.data.map(booking => `
        <div class="booking-item">
          <b>${booking['Name']}</b> (${booking['Student ID']})<br>
          <small>üè† ${booking['Room']}</small><br>
          <small>üìÖ ${booking.dateStr} ${booking['Start Time']} - ${booking['End Time']}</small><br>
          <small>üîë ${booking['Password']}</small>
        </div>`).join('');
      bookingListDiv.innerHTML = html;
    } else bookingListDiv.innerHTML = "<p>[‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á]</p>";
    console.log("Bookings loaded:", result_Get.data);
  } catch (e) {
    bookingListDiv.innerHTML = "<p>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>";
  }
}*/
async function fetchAndDisplayAvailability() {
  const today = new Date().toISOString().split("T")[0]; // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  bookingListDiv.innerHTML = "<p>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á...</p>";

  try {
    const response = await fetch(`${scriptURL}?action=checkAvailableRooms&date=${today}`);
    const result = await response.json();
    console.log("Available slots for",  result);


    if (result.status === "success" && result.availability.length > 0) {
      let [year, month, day] = result.date.split("-");
      let html = `<h3 style="text-align:center">üóì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${day}-${month}-${year}</h3>`;
      result.availability.forEach(roomData => {
        html += `<div class="booking-item">
          <b>${roomData.room}</b><br>`;
        if (roomData.freeSlots.length > 0) {
          html += roomData.freeSlots.map(slot => 
            `üïì ${slot.start} - ${slot.end}<br>`
          ).join('');
        } else {
          html += `<span style="color:var(--error)">‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á</span>`;
        }
        html += "</div>";
      });
      bookingListDiv.innerHTML = html;
    } else {
      bookingListDiv.innerHTML = "<p>‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>";
    }
  } catch (e) {
    bookingListDiv.innerHTML = "<p>üö´ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ</p>";
    console.error("Error:", e);
  }
}

const viewAvailableBtn = document.getElementById("viewAvailableBtn");

viewAvailableBtn.addEventListener("click", () => {
  flipCard.classList.add("is-flipped");
  fetchAndDisplayAvailability();
});


backToFormBtn.addEventListener("click", () => flipCard.classList.remove("is-flipped"));

const form = document.getElementById("bookingForm");
const btn = document.getElementById("submitBtn");
const popup = document.getElementById("popup");
const resultBox = document.getElementById("resultBox");
const alertBox = document.getElementById("alertBox");
const timeInput = document.getElementById("time");

let alertTimeout;
function showAlert(msg, ok = false) {
  clearTimeout(alertTimeout);
  alertBox.textContent = msg;
  alertBox.className = "alert-box show";
  if (ok) alertBox.classList.add("success");
  alertTimeout = setTimeout(() => alertBox.classList.remove("show"), 4000);
}
timeInput.addEventListener("change", () => {
    //const t = new Date(timeInput.value);
     const t = new Date(`2000-01-01T${timeInput.value}`);
    t.setMinutes(0, 0, 0);
    const h = String(t.getHours()).padStart(2, "0");
    timeInput.value = `${h}:00`;
  });

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  btn.disabled = true;
  popup.style.display = "block";
  resultBox.style.display = "none";

  const name = document.getElementById("name").value.trim();
  const studentId = document.getElementById("studentId").value.trim();
  const room = document.getElementById("room").value;
  const date = document.getElementById("date").value;
  const time = document.getElementById("time").value;
  const password = Math.floor(1000 + Math.random() * 9000);

  const timeString = `${date}T${time}`;
  const formData = new URLSearchParams({
  name,
  studentId,
  room,
  time: timeString,
  password
});
  try {
    const res = await fetch(scriptURL, { method: "POST", body: formData });
    const result = await res.json();
    //console.log(formData.toString());
    popup.style.display = "none";

    if (result.status === "duplicate") {
      showAlert(`üö´ ${result.message}`);
      btn.disabled = false;
      return;
    }
    if (result.status === "success") {
      const start = new Date(timeString);
      const end = new Date(start.getTime() + 1 * 60 * 60 * 1000);
      resultBox.style.display = "block";
      resultBox.innerHTML = `
        ‚úÖ <b>‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</b><br><br>
        ‡∏´‡πâ‡∏≠‡∏á: <b>${room}</b><br>
        ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: <b>${name}</b> (${studentId})<br>
        ‡πÄ‡∏ß‡∏•‡∏≤: <b>${start.toLocaleString("th-TH")}</b> - <b>${end.toLocaleTimeString("th-TH")}</b><br><br>
        üîë ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô: <b>${password}</b>`;
      form.reset();
      showAlert("‚úÖ ‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", true);
    }
  } catch (err) {
    popup.style.display = "none";
    showAlert("üö´ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠");
  }
  setTimeout(() => btn.disabled = false, 2500);
});
</script>
</body>
</html>
